if(typeof MOVI=="undefined"||!MOVI){var MOVI={};}MOVI.namespace=function(){var a=arguments,o=null,i,j,d;for(i=0;i<a.length;i=i+1){d=a[i].split(".");o=MOVI;for(j=(d[0]=="MOVI")?1:0;j<d.length;j=j+1){o[d[j]]=o[d[j]]||{};o=o[d[j]];}}return o;};MOVI.extend=YAHOO.extend;MOVI.log=YAHOO.log;MOVI.init=function(callback,moviBase,yuiReadyCallback,yuiModules){var _YUI_BASE_DIR="http://yui.yahooapis.com/2.7.0/build/";if(!YAHOO.lang.isFunction(callback)){callback=function(){};}if(!YAHOO.lang.isFunction(yuiReadyCallback)){yuiReadyCallback=undefined;}if(!YAHOO.lang.isArray(yuiModules)){yuiModules=[];}var yuiLoader=new YAHOO.util.YUILoader({require:yuiModules.concat(["yahoo","dom","element","get","event","logger","slider","container"]),base:_YUI_BASE_DIR,loadOptional:true,filter:"RAW",onSuccess:function(){if(yuiReadyCallback){yuiReadyCallback();}YAHOO.widget.Logger.enableBrowserConsole();if(!YAHOO.lang.isString(moviBase)){throw new Error("MOVI base directory is not specified.","movi.js");return false;}YAHOO.util.Get.css(moviBase+"/style/movi.css",{});if(YAHOO.env.ua.ie>0){YAHOO.util.Get.css(moviBase+"/style/movi_ie.css",{});}YAHOO.util.Get.script([moviBase+"/config.js",moviBase+"/modelviewer.js",moviBase+"/stencil.js",moviBase+"/stencilset.js",moviBase+"/shape.js",moviBase+"/node.js",moviBase+"/edge.js",moviBase+"/canvas.js",moviBase+"/marker.js",moviBase+"/annotation.js",moviBase+"/modelnavigator.js",moviBase+"/shapeselect.js",moviBase+"/toolbar.js",moviBase+"/zoom.js"],{onSuccess:callback,onFailure:function(){throw new Error("Unable to load MOVI modules from base dir '"+moviBase+"'","movi.js");}});},onFailure:function(msg,xhrobj){var m="Unable to load YUI modules from base dir '"+_YUI_BASE_DIR+"': "+msg;if(xhrobj){m+=", "+YAHOO.lang.dump(xhrobj);}throw new Error(m,"movi.js");}});yuiLoader.insert();};MOVI.namespace("config");MOVI.config={MODEL_MARGIN:50};MOVI.namespace("widget");(function(){var _SCROLLBOX_CLASS_NAME="movi-scrollbox",_MODELIMG_CLASS_NAME="movi-modelimg";var _instances=new Array();MOVI.widget.ModelViewer=function(el){this._index=_instances.length;_instances[this._index]=this;MOVI.widget.ModelViewer.superclass.constructor.call(this,el);this.onZoomLevelChange=new YAHOO.util.CustomEvent("movi-zoomLevelChange",this);this.onZoomLevelChangeStart=new YAHOO.util.CustomEvent("movi-zoomLevelChangeStart",this);this.onZoomLevelChangeEnd=new YAHOO.util.CustomEvent("movi-zoomLevelChangeEnd",this);this.onModelLoadStart=new YAHOO.util.CustomEvent("movi-modelLoadStart",this);this.onModelLoadEnd=new YAHOO.util.CustomEvent("movi-modelLoadEnd",this);var existingScrollboxArr=this.getElementsByClassName(_SCROLLBOX_CLASS_NAME);if(existingScrollboxArr.length==1){this._scrollbox=new YAHOO.util.Element(existingScrollboxArr[0]);}else{this._scrollbox=new YAHOO.util.Element(document.createElement("div"));this._scrollbox.addClass(_SCROLLBOX_CLASS_NAME);this.appendChild(this._scrollbox);}this._scrollbox.set("id",_SCROLLBOX_CLASS_NAME+this._index);var imgEl=new YAHOO.util.Element(document.createElement("img"));imgEl.set("id",_MODELIMG_CLASS_NAME+this._index);imgEl.addClass(_MODELIMG_CLASS_NAME);this._scrollbox.appendChild(imgEl);this.setStyle("-moz-user-select","-moz-none");this.setStyle("-webkit-user-select","none");this.setStyle("-khtml-user-select","none");if(YAHOO.env.ua.ie>0){this.set("unselectable","on");}this._image=new YAHOO.util.Element(_MODELIMG_CLASS_NAME+this._index);this.addListener("mousedown",this._onMouseDown,this,this,true);YAHOO.util.Event.addListener(document,"mouseup",this._onMouseUp,this,this,true);this._loadOptions={};};MOVI.widget.ModelViewer.getInstance=function(id){if(YAHOO.lang.isNumber(id)){return _instances[id];}else{for(var i=0;i<_instances.length;i++){if(_instances[i].get("id")==id){return _instances[i];}}}};MOVI.widget.ModelViewer.removeInstance=function(id){if(YAHOO.lang.isNumber(id)){YAHOO.util.Event.purgeElement(_instances[id].get("element"),true);_instances[id].get("element").innerHTML="";delete _instances[id];_instances.splice(id,1);}};MOVI.extend(MOVI.widget.ModelViewer,YAHOO.util.Element,{_modelUri:"",_loadOptions:null,_scrollbox:null,_image:null,_imageWidth:0,_imageHeight:0,_zoomLevel:100,_syncResources:null,canvas:null,onZoomLevelChange:null,onZoomLevelChangeStart:null,onZoomLevelChangeEnd:null,onModelLoadStart:null,onModelLoadEnd:null,_onSuccess:function(){MOVI.log("Model loaded successfully.","info","modelviewer.js");var scope=this._loadOptions.scope||window;if(this._loadOptions.onSuccess){this._loadOptions.onSuccess.call(scope,this);}this.onModelLoadEnd.fire(this._modelUri);this.onZoomLevelChangeEnd.fire(this.getZoomLevel());},_onLoadFailure:function(){MOVI.log("Could not load model.","error","modelviewer.js");var scope=this._loadOptions.scope||window;if(this._loadOptions.onFailure){this._loadOptions.onFailure.call(scope,this);}},_onLoadTimeout:function(){MOVI.log("A timeout occured while trying to load model.","error","modelviewer.js");var scope=this._loadOptions.scope||window;if(this._loadOptions.onTimeout){this._loadOptions.onTimeout.call(scope,this);}else{if(this._loadOptions.onFailure){this._loadOptions.onFailure.call(scope,this);}}},_onStencilSetLoadFailure:function(){MOVI.log("Could not load stencil set for model.","error","modelviewer.js");var scope=this._loadOptions.scope||window;if(this._loadOptions.onFailure){this._loadOptions.onFailure.call(scope,this);}},_onStencilSetLoadTimeout:function(){MOVI.log("A timeout occured while trying to load stencil set for model.","error","modelviewer.js");var scope=this._loadOptions.scope||window;if(this._loadOptions.onTimeout){this._loadOptions.onTimeout.call(scope,this);}else{if(this._loadOptions.onFailure){this._loadOptions.onFailure.call(scope,this);}}},_syncLoadingReady:function(resource){for(var i=0;i<this._syncResources.length;i++){if(this._syncResources[i]==resource||(this._syncResources[i].indexOf("_")>0&&this._syncResources[i].substring(0,this._syncResources[i].indexOf("_"))==resource)){break;}}if(i>=0){this._syncResources.splice(i,1);}if(this._syncResources.length==0){if(this._loadOptions.onlyImage){this._onSuccess();}else{if(this._initCanvas()){this._onSuccess();}}}},_initCanvas:function(){for(var i=0;i<this._ssextensions.length;i++){this.canvas.stencilset.addExtension(this._ssextensions[i]);}var prefix="movi_"+this._index+"-";try{this.canvas=new MOVI.model.Canvas(this,this.canvas,prefix);}catch(e){MOVI.log("A "+e.name+" occured while trying to initialize the model: "+e.message,"error","modelviewer.js");this._onLoadFailure();return false;}this._scrollbox.appendChild(this.canvas);return true;},getIndex:function(){return this._index;},loadModel:function(uri,opt){if(!YAHOO.lang.isString(uri)){throw new URIError("No valid URI passed to loadModel.","modelviewer.js");this._onLoadFailure();}if(uri.charAt(uri.length-1)=="/"){uri=uri.substr(0,uri.length-1);}this._modelUri=uri;this._loadOptions=opt||{};if(!this._loadOptions.timeout){this._loadOptions.timeout=15000;}this.onModelLoadStart.fire(this._modelUri);this.onZoomLevelChangeStart.fire(this.getZoomLevel());this._syncResources=new Array();if(!this._loadOptions.onlyImage){this._syncResources.push("data");var jsonp=encodeURIComponent("MOVI.widget.ModelViewer.getInstance("+this._index+").loadModelCallback");var url=uri+"/json?jsonp="+jsonp;if(YAHOO.lang.isFunction(this._loadOptions.urlModificationFunction)){url=this._loadOptions.urlModificationFunction.call(this._loadOptions.scope||this,url,this,"json");}var transactionObj=YAHOO.util.Get.script(url,{onFailure:this._onLoadFailure,onTimeout:this._onLoadTimeout,timeout:this._loadOptions.timeout,scope:this});}this._loadImage(uri);},_loadImage:function(uri){this._syncResources.push("image");var imgUrl=uri+"/png?"+(new Date()).getTime();if(YAHOO.lang.isFunction(this._loadOptions.urlModificationFunction)){imgUrl=this._loadOptions.urlModificationFunction.call(this._loadOptions.scope||this,imgUrl,this,"png");}this._image.setStyle("width","");this._image.setStyle("height","");var self=this;this._image.get("element").onload=function(){self._imageWidth=parseInt(self._image.getStyle("width"),10)||self._image.get("element").offsetWidth;self._imageHeight=parseInt(self._image.getStyle("height"),10)||self._image.get("element").offsetHeight;self._syncLoadingReady("image");};this._image.set("src",imgUrl);},loadModelCallback:function(jsonObj){if(this.canvas!=null){this._scrollbox.removeChild(this.canvas);}this.canvas=jsonObj;if(!this.canvas.stencilset){MOVI.log("Could not find stencil set definition for model.","error","canvas.js");this._onFailure();}if(this.canvas.ssextensions){for(var i=0;i<this.canvas.ssextensions.length;i++){this._syncResources.push("ssextension_"+i);}}if(this.canvas.stencilset.url.substring(0,7)!="http://"){var index=this._modelUri.substring(7).indexOf("/");this.canvas.stencilset.url=this._modelUri.substring(0,7+index)+this.canvas.stencilset.url;}var jsonp=encodeURIComponent("MOVI.widget.ModelViewer.getInstance("+this._index+").loadStencilSetCallback");var pathStringIndex=this.canvas.stencilset.url.indexOf("/stencilsets/");var url=this.canvas.stencilset.url.substring(0,pathStringIndex)+"/jsonp?resource="+encodeURIComponent(this.canvas.stencilset.url.substring(pathStringIndex+13))+"&type=stencilset&jsonp="+jsonp;if(YAHOO.lang.isFunction(this._loadOptions.urlModificationFunction)){url=this._loadOptions.urlModificationFunction.call(this._loadOptions.scope||this,url,this,"stencilset");}var transactionObj=YAHOO.util.Get.script(url,{onFailure:this._onStencilSetLoadFailure,onTimeout:this._onStencilSetLoadTimeout,data:this._loadOptions,timeout:this._loadOptions.timeout,scope:this});this._ssextensions=new Array();if(this.canvas.ssextensions){for(var i=0;i<this.canvas.ssextensions.length;i++){var ssext_jsonp=encodeURIComponent("MOVI.widget.ModelViewer.getInstance("+this._index+").loadStencilSetExtensionCallback");var ssext_url=this.canvas.stencilset.url.substring(0,pathStringIndex)+"/jsonp?resource="+encodeURIComponent(this.canvas.ssextensions[i])+"&type=ssextension&jsonp="+ssext_jsonp;if(YAHOO.lang.isFunction(this._loadOptions.urlModificationFunction)){ssext_url=this._loadOptions.urlModificationFunction.call(this._loadOptions.scope||this,ssext_url,this,"ssextension");}var ssext_transactionObj=YAHOO.util.Get.script(ssext_url,{onFailure:this._onStencilSetLoadFailure,onTimeout:this._onStencilSetLoadTimeout,data:this._loadOptions,timeout:this._loadOptions.timeout,scope:this});}}},loadStencilSetCallback:function(jsonObj){this.canvas.stencilset=new MOVI.stencilset.Stencilset(jsonObj);this._syncLoadingReady("data");},loadStencilSetExtensionCallback:function(jsonObj){this._ssextensions.push(jsonObj);this._syncLoadingReady("ssextension");},getImgWidth:function(){return this._imageWidth||this.getScrollboxEl().get("element").offsetWidth;},getImgHeight:function(){return this._imageHeight||this.getScrollboxEl().get("element").offsetHeight;},getModelUri:function(){return this._modelUri;},getScrollboxEl:function(){return this._scrollbox;},scrollToShape:function(shape){if("string"==typeof(shape)){shape=this.canvas.getShape(shape);if(null==shape){return null;}}if(null!=(h=this.getScrollboxEl().getStyle("height").match(/(\d+)px/)||this.getScrollboxEl().get("element").offsetHeight)&&null!=(w=this.getScrollboxEl().getStyle("width").match(/(\d+)px/)||this.getScrollboxEl().get("element").offsetWidth)){var bounds=shape.getAbsBounds();var origin={x:bounds.upperLeft.x+(bounds.lowerRight.x-bounds.upperLeft.x)/2,y:bounds.upperLeft.y+(bounds.lowerRight.y-bounds.upperLeft.y)/2};var zoomFactor=this.getZoomLevel()/100;var target={x:parseInt(origin.x*zoomFactor-parseInt(w[1])/2),y:parseInt(origin.y*zoomFactor-parseInt(h[1])/2)};this.getScrollboxEl().set("scrollTop",target.y);this.getScrollboxEl().set("scrollLeft",target.x);}else{throw new Error("Unable to calculate scrollbox dimensions","modelviewer.js");}return shape;},centerScrollTo:function(x,y){if(!YAHOO.lang.isNumber(x)||!YAHOO.lang.isNumber(y)){throw new TypeError("The coordinates passed to centerScrollTo(x, y) have to be of type Integer.","modelviewer.js");}var left=Math.round(x-parseInt(this.getScrollboxEl().getStyle("width"),10)/2),top=Math.round(y-parseInt(this.getScrollboxEl().getStyle("height"),10)/2);this.getScrollboxEl().set("scrollLeft",left);this.getScrollboxEl().set("scrollTop",top);},setZoomLevel:function(percent,notifyStartEnd){if(!YAHOO.lang.isNumber(percent)){throw new TypeError("The parameter passed to have to setZoomLevel has to be of type Number.","modelviewer.js");}if(percent<=0){percent=0;}else{if(percent>100){percent=100;}}this._zoomLevel=percent;this._image.setStyle("width",Math.round(this.getImgWidth()*this._zoomLevel/100)+"px");this._image.setStyle("height",Math.round(this.getImgHeight()*this._zoomLevel/100)+"px");if(notifyStartEnd!==false){this.onZoomLevelChangeStart.fire(this._zoomLevel);}this.onZoomLevelChange.fire(this._zoomLevel);if(notifyStartEnd!==false){this.onZoomLevelChangeEnd.fire(this._zoomLevel);}},getZoomLevel:function(){return this._zoomLevel;},fitModelToViewer:function(){var scaleHorizontal=(this.getScrollboxEl().get("offsetWidth")-5)/this.getImgWidth();var scaleVertical=(this.getScrollboxEl().get("offsetHeight")-5)/this.getImgHeight();var scale=(scaleHorizontal<scaleVertical)?scaleHorizontal:scaleVertical;if(scale>1){scale=1;}this.setZoomLevel(scale*100);},_onMouseDown:function(ev){var SCROLLBAR_WIDTH=20;var mouseAbsXY=YAHOO.util.Event.getXY(ev);var ul=YAHOO.util.Dom.getXY(this._scrollbox);var lrX=ul[0]+this.getScrollboxEl().get("offsetWidth"),lrY=ul[1]+this.getScrollboxEl().get("offsetHeight");if(this.getScrollboxEl().get("element").clientWidth<this.getScrollboxEl().get("element").scrollWidth){if((mouseAbsXY[1]>=lrY-20)&&(mouseAbsXY[1]<=lrY)){return;}}if(this.getScrollboxEl().get("element").clientHeight<this.getScrollboxEl().get("element").scrollHeight){if((mouseAbsXY[0]>=lrX-20)&&(mouseAbsXY[0]<=lrX)){return;}}if(ev.target==this._scrollbox.get("element")||ev.target==this._image.get("element")||ev.target==this.canvas.get("element")){YAHOO.util.Event.preventDefault(ev);YAHOO.util.Event.stopPropagation(ev);}this._scrollbox.removeListener("mousemove",this._onModelDrag);this._mouseCoords={x:mouseAbsXY[0],y:mouseAbsXY[1]};this._scrollbox.addListener("mousemove",this._onModelDrag,this,this,true);this._isDragging=true;},_onMouseUp:function(ev){YAHOO.util.Event.preventDefault(ev);this._scrollbox.removeListener("mousemove",this._onModelDrag);this._isDragging=false;},_onModelDrag:function(ev){YAHOO.util.Event.preventDefault(ev);var mouseAbsXY=YAHOO.util.Event.getXY(ev);var sl=this._scrollbox.get("scrollLeft");var st=this._scrollbox.get("scrollTop");this._scrollbox.set("scrollLeft",sl-(mouseAbsXY[0]-this._mouseCoords.x));this._scrollbox.set("scrollTop",st-(mouseAbsXY[1]-this._mouseCoords.y));this._mouseCoords.x=mouseAbsXY[0];this._mouseCoords.y=mouseAbsXY[1];}});})();MOVI.namespace("stencilset");(function(){MOVI.stencilset.Stencil=function(jsonObject,propertyPackages,namespace){YAHOO.lang.augmentObject(this,jsonObject,true);if(this.propertyPackages){var props={};for(var propIndex in this.properties){var prop=this.properties[propIndex];props[prop.id]=prop;}for(var i=0;i<this.propertyPackages.length;i++){var propPackName=this.propertyPackages[i];var propPack=propertyPackages[propPackName];if(propPack){for(var j=0;j<propPack.length;j++){var prop=propPack[j];props[prop.id]=prop;}}}this.properties=[];for(var propKey in props){if(!(props[propKey] instanceof Function)){this.properties.push(props[propKey]);}}}this.stencilSetNamespace=namespace;};})();MOVI.namespace("stencilset");(function(){MOVI.stencilset.Stencilset=function(jsonObj){this.title=jsonObj.title;this.namespace=jsonObj.namespace;this.description=jsonObj.description;this.stencils={};if(!jsonObj.stencils){MOVI.log("Stencilset contains no stencil definitions","warning","stencilset.js");}this.propertyPackages={};if(jsonObj.propertyPackages){for(var i=0;i<jsonObj.propertyPackages.length;i++){var pp=jsonObj.propertyPackages[i];this.propertyPackages[pp.name]=pp.properties;}}for(var key in jsonObj.stencils){if(!YAHOO.lang.hasOwnProperty(jsonObj.stencils,key)){continue;}var stencil=jsonObj.stencils[key];this.stencils[stencil.id]=new MOVI.stencilset.Stencil(stencil,this.propertyPackages,jsonObj.namespace);}};MOVI.stencilset.Stencilset.prototype={stencils:null,getStencil:function(id){return this.stencils[id]||null;},addExtension:function(jsonObj){if(jsonObj.propertyPackages){for(var i=0;i<jsonObj.propertyPackages.length;i++){var pp=jsonObj.propertyPackages[i];this.propertyPackages[pp.name]=pp.properties;}}if(jsonObj.stencils){for(var i=0;i<jsonObj.stencils.length;i++){var stencil=jsonObj.stencils[i];this.stencils[stencil.id]=new MOVI.stencilset.Stencil(stencil,this.propertyPackages,jsonObj.namespace);}}if(jsonObj.properties){for(var i=0;i<jsonObj.properties.length;i++){var property=jsonObj.properties[i];for(var key in this.stencils){if(!YAHOO.lang.hasOwnProperty(this.stencils,key)){continue;}var stencil=this.stencils[key];for(var j=0;j<property.roles.length;j++){for(var k=0;k<stencil.roles.length;k++){if(property.roles[j]==stencil.roles[k]){for(var l=0;l<property.properties.length;l++){stencil.properties.push(property.properties[l]);}}}}}}}}};})();MOVI.namespace("model");(function(){var _createHostElement=function(){var el=document.createElement("div");return el;};var _getSubclassForJSONObj=function(jsonObj,stencilset){var stencil=stencilset.getStencil(jsonObj.stencil.id);if(stencil){if(stencil.type=="node"){return MOVI.model.Node;}else{if(stencil.type=="edge"){return MOVI.model.Edge;}}}return MOVI.model.Shape;};MOVI.model.Shape=function(jsonObj,stencilset,parent,prefix,attr){YAHOO.lang.augmentObject(this,jsonObj,true);if(!stencilset){throw new Error("No stencilset associated for shape with resource id"+this.resourceId+".","shape.js");return false;}if(!this.resourceId){throw new Error("The shape has no resource id.","shape.js");return false;}if(!this.stencil||!this.stencil.id){throw new Error("No stencil definition found for shape with resource id "+this.resourceId,"shape.js");return false;}var sId=this.stencil.id;this.stencil=stencilset.getStencil(sId);if(!this.stencil){throw new Error("Could not find definition for stencil "+sId+" in stencilset "+stencilset.namespace+".","shape.js");return false;}this.parentShape=parent;attr=attr||{};el=_createHostElement.call(this,attr);MOVI.model.Shape.superclass.constructor.call(this,el,attr);this.set("id",prefix+this.resourceId);var childSh=this.childShapes;this.childShapes={};for(var i=0;i<childSh.length;i++){var child=childSh[i];var subclass=_getSubclassForJSONObj(child,stencilset);child=new subclass(child,stencilset,this,prefix);this.childShapes[child.resourceId]=child;this.appendChild(child);}};MOVI.extend(MOVI.model.Shape,YAHOO.util.Element,{parentShape:null,getCanvas:function(){var e=this;while(e.parentShape!=null){e=e.parentShape;}return e;},getIncomingShapes:function(){if(!this._incomingShapes){var incoming=[];var canvas=this.getCanvas();if(canvas){var nodes=canvas.shapes;for(var i in nodes){if(!YAHOO.lang.hasOwnProperty(nodes,i)){continue;}if((nodes[i].outgoing||[]).length>0){var isOutgoing=false;for(var j=0,oLen=nodes[i].outgoing.length;j<oLen;++j){if(nodes[i].outgoing[j].resourceId==this.resourceId){incoming.push(nodes[i]);break;}}}}}this._incomingShapes=incoming;}return this._incomingShapes;},getOutgoingShapes:function(){if(!this._outgoingShapes){var outgoings=[];var canvas=this.getCanvas();if(canvas){var og=this.outgoing||[];for(var i=0,len=og.length;i<len;++i){var shape=canvas.getShape(og[i].resourceId);if(shape){outgoings.push(shape);}}}this._outgoingShapes=outgoings;}return this._outgoingShapes;},getBounds:function(){if(!this.bounds){if(this.dockers){var min,max;for(var i=0,len=this.dockers.length;i<len;++i){var pos={x:this.dockers[i].x,y:this.dockers[i].y};if(i==0){var nodes=this.getIncomingShapes();if(nodes.length>0){var bounds=nodes[0].getAbsBounds();pos.x+=bounds.upperLeft.x;pos.y+=bounds.upperLeft.y;}}if(i==len-1&&(this.outgoing||[]).length>0){var nodes=this.getOutgoingShapes();if(nodes.length>0){var bounds=nodes[0].getAbsBounds();pos.x+=bounds.upperLeft.x;pos.y+=bounds.upperLeft.y;}}if(!min){min={x:pos.x,y:pos.y};}if(!max){max={x:pos.x,y:pos.y};}min.x=Math.min(min.x,pos.x);min.y=Math.min(min.y,pos.y);max.x=Math.max(max.x,pos.x);max.y=Math.max(max.y,pos.y);}if(min&&max){this.bounds={upperLeft:min,lowerRight:max};}}if(!this.bounds){this.bounds={upperLeft:{x:0,y:0},lowerRight:{x:0,y:0}};}}return{upperLeft:{x:this.bounds.upperLeft.x,y:this.bounds.upperLeft.y},lowerRight:{x:this.bounds.lowerRight.x,y:this.bounds.lowerRight.y}};},getAbsBounds:function(){var absBounds=this.getBounds();var e=this;while(e.parentShape!=null&&e.parentShape.parentShape!=null){e=e.parentShape;var b=e.getBounds();absBounds.upperLeft.x+=b.upperLeft.x;absBounds.upperLeft.y+=b.upperLeft.y;absBounds.lowerRight.x+=b.upperLeft.x;absBounds.lowerRight.y+=b.upperLeft.y;}return absBounds;},hasChildShapes:function(){for(var key in this.childShapes){if(!YAHOO.lang.hasOwnProperty(this.childShapes,key)){continue;}return true;}return false;},getStencil:function(){return this.stencil;},isNode:function(){return false;},isEdge:function(){return false;}});})();MOVI.namespace("model");(function(){var _CLASS_NAME="movi-node";MOVI.model.Node=function(jsonObj,stencilset,parent,prefix){var attr={};MOVI.model.Node.superclass.constructor.call(this,jsonObj,stencilset,parent,prefix,attr);this.set("className",_CLASS_NAME);this.getCanvas().getModelViewer().onZoomLevelChangeEnd.subscribe(this.update,this,true);this.update();};MOVI.extend(MOVI.model.Node,MOVI.model.Shape,{update:function(){var zoomFactor=this.getCanvas().getModelViewer().getZoomLevel()/100;var left=Math.round(this.bounds.upperLeft.x*zoomFactor);var top=Math.round(this.bounds.upperLeft.y*zoomFactor);var width=Math.round((this.bounds.lowerRight.x-this.bounds.upperLeft.x)*zoomFactor);var height=Math.round((this.bounds.lowerRight.y-this.bounds.upperLeft.y)*zoomFactor);this.setStyle("left",left+"px");this.setStyle("top",top+"px");this.setStyle("width",width+"px");this.setStyle("height",height+"px");},isNode:function(){return true;}});})();MOVI.namespace("model");(function(){var _CLASS_NAME="movi-edge";MOVI.model.Edge=function(jsonObj,stencilset,parent,prefix){var attr={};MOVI.model.Node.superclass.constructor.call(this,jsonObj,stencilset,parent,prefix,attr);this.set("className",_CLASS_NAME);};MOVI.extend(MOVI.model.Edge,MOVI.model.Shape,{update:function(){},_getIntersectionPoint:function(bounds,p1,p2){var linearEquation=function(x){return p1.y+(p2.y-p1.y)/(p2.x-p1.x)*(x-p1.x);};var inverseLinearEquation=function(x){return p1.x+(p2.x-p1.x)/(p2.y-p1.y)*(x-p1.y);};var s=[];s[0]={x:inverseLinearEquation(bounds.upperLeft.y),y:bounds.upperLeft.y};s[1]={x:bounds.lowerRight.x,y:linearEquation(bounds.lowerRight.x)};s[2]={x:inverseLinearEquation(bounds.lowerRight.y),y:bounds.lowerRight.y};s[3]={x:bounds.upperLeft.x,y:linearEquation(bounds.upperLeft.x)};for(var i=0;i<=3;i++){if(s[i].x==Infinity||s[i].y==Infinity){continue;}if(isNaN(s[i].x)){s[i].x=(p2.x>p1.x)?bounds.lowerRight.x:bounds.upperLeft.x;}if(isNaN(s[i].y)){s[i].y=(p2.y>p1.y)?bounds.lowerRight.y:bounds.upperLeft.y;}var tx=(s[i].x-p1.x)/(p2.x-p1.x),ty=(s[i].y-p1.y)/(p2.y-p1.y);if(Math.abs(tx)==Infinity||Math.abs(ty)==Infinity){continue;}if(isNaN(tx)&&ty>=0&&ty<=1){return{x:p1.x,y:p1.y+ty*(p2.y-p1.y)};}else{if(isNaN(ty)&&tx>=0&&tx<=1){return{x:p1.x+tx*(p2.x-p1.x),y:p1.y};}else{if((Math.round(tx*10)/10)==(Math.round(ty*10)/10)&&tx>=0&&tx<=1){return{x:p1.x+tx*(p2.x-p1.x),y:p1.y+tx*(p2.y-p1.y)};}}}}return{x:p1.x,y:p1.y};},getCoordinates:function(){var coords=[];var incoming=this.getIncomingShapes(),outgoing=this.getOutgoingShapes();var len=this.dockers.length;for(var i=0;i<len;++i){var pos={x:this.dockers[i].x,y:this.dockers[i].y};if(i==0&&incoming.length>0){var bounds=incoming[0].getAbsBounds();pos.x+=bounds.upperLeft.x;pos.y+=bounds.upperLeft.y;}if(i==(len-1)&&outgoing.length>0){var bounds=outgoing[0].getAbsBounds();pos.x+=bounds.upperLeft.x;pos.y+=bounds.upperLeft.y;}coords.push(pos);}if(incoming.length>0){coords[0]=this._getIntersectionPoint(incoming[0].getAbsBounds(),coords[0],coords[1]);}if(outgoing.length>0){coords[len-1]=this._getIntersectionPoint(outgoing[0].getAbsBounds(),coords[len-1],coords[len-2]);}return coords;},isEdge:function(){return true;}});})();MOVI.namespace("model");(function(){var _CLASS_NAME="movi-canvas";MOVI.model.Canvas=function(modelviewer,jsonObj,prefix){this._modelviewer=modelviewer;var attr={};MOVI.model.Canvas.superclass.constructor.call(this,jsonObj,jsonObj.stencilset,null,prefix,attr);this.set("className",_CLASS_NAME);this.shapes={};this._resourceIds=[];this._indexShapes();this._modelviewer.onZoomLevelChangeStart.subscribe(function(){this.setStyle("display","none");},this,true);this._modelviewer.onZoomLevelChangeEnd.subscribe(function(){this._update();this.setStyle("display","block");},this,true);this._update();};MOVI.extend(MOVI.model.Canvas,MOVI.model.Shape,{_modelviewer:null,shapes:null,_indexShapes:function(recShape){recShape=recShape||this;for(var key in recShape.childShapes){if(!YAHOO.lang.hasOwnProperty(recShape.childShapes,key)){continue;}var child=recShape.childShapes[key];this.shapes[child.resourceId]=child;this._resourceIds.push(child.resourceId);this._indexShapes(child);}},_update:function(){var zoomFactor=this._modelviewer.getZoomLevel()/100;var minX,minY,maxX,maxY,bounds;for(var i in this.childShapes){if(!YAHOO.lang.hasOwnProperty(this.childShapes,i)){continue;}bounds=this.childShapes[i].getAbsBounds();if(minX==undefined){minX=bounds.upperLeft.x;}else{minX=Math.min(minX,bounds.upperLeft.x);}if(minY==undefined){minY=bounds.upperLeft.y;}else{minY=Math.min(minY,bounds.upperLeft.y);}if(maxX==undefined){maxX=bounds.upperLeft.x;}else{maxX=Math.max(maxX,bounds.upperLeft.x);}if(maxY==undefined){maxY=bounds.upperLeft.y;}else{maxY=Math.max(maxY,bounds.upperLeft.y);}}for(var i in this.childShapes){if(!YAHOO.lang.hasOwnProperty(this.childShapes,i)){continue;}bounds=this.childShapes[i].bounds;bounds.upperLeft.x-=minX;bounds.upperLeft.y-=minY;bounds.lowerRight.x-=minX;bounds.lowerRight.y-=minY;this.childShapes[i].update();if(this.childShapes[i].isEdge()&&this.childShapes[i].dockers&&this.childShapes[i].dockers.length>2){for(var j=1;j<this.childShapes[i].dockers.length-1;j++){this.childShapes[i].dockers[j].x-=minX;this.childShapes[i].dockers[j].y-=minY;}}}if(!this.bounds||!this.bounds.upperLeft||!this.bounds.lowerRight){this.bounds={upperLeft:{x:0,y:0},lowerRight:{x:maxX-minX,y:maxY-minY}};}var left=(MOVI.config.MODEL_MARGIN/2)*zoomFactor+"px";var top=(MOVI.config.MODEL_MARGIN/2)*zoomFactor+"px";var width=(this._modelviewer.getImgWidth()-MOVI.config.MODEL_MARGIN)*zoomFactor+"px";var height=(this._modelviewer.getImgHeight()-MOVI.config.MODEL_MARGIN)*zoomFactor+"px";this.setStyle("left",left);this.setStyle("top",top);this.setStyle("width",width);this.setStyle("height",height);},getShape:function(resourceId){return this.shapes[resourceId]||null;},getModelViewer:function(){return this._modelviewer;},getNodes:function(){var nodes={};for(var key in this.shapes){if(!YAHOO.lang.hasOwnProperty(this.shapes,key)){continue;}if(this.shapes[key].stencil.type=="node"){nodes[key]=this.shapes[key];}}return nodes;},getEdges:function(){var edges={};for(var key in this.shapes){if(!YAHOO.lang.hasOwnProperty(this.shapes,key)){continue;}if(this.shapes[key].stencil.type=="edge"){edges[key]=this.shapes[key];}}return edges;},getResourceIds:function(){return this._resourceIds;}});})();MOVI.namespace("util");(function(){var _MARKER_RECT_CLASS_NAME="movi-marker",_ICON_CLASS_NAME="movi-marker-icon",_ICON_MARGIN=-10;MOVI.util.Overlay=function(modelviewer,coords,style){if(coords.length==0){throw new Error("No coordinates specified for the Overlay!");}if(!style){style={};}this.style={};this.style.color=style.color||"#FF0000";this.style.width=style.width||10;this.style.opacity=style.opacity||0.4;this.modelviewer=modelviewer;this.coords=coords;var canvasEl=document.createElement("canvas");if(canvasEl.getContext){var ctx=canvasEl.getContext("2d");MOVI.util.Overlay.superclass.constructor.call(this,canvasEl,{});this.set("width",parseInt(this.modelviewer.canvas.getStyle("width")));this.set("height",parseInt(this.modelviewer.canvas.getStyle("height")));ctx.beginPath();ctx.lineJoin="round";ctx.lineCap="round";ctx.moveTo(coords[0].x,coords[0].y);for(var i=1;i<coords.length;i++){ctx.lineTo(coords[i].x,coords[i].y);}ctx.moveTo(500,800);ctx.lineTo(500,1000);ctx.strokeStyle="rgba("+parseInt(this.style.color.substring(1,3),16)+","+parseInt(this.style.color.substring(3,5),16)+","+parseInt(this.style.color.substring(5,7),16)+","+this.style.opacity+")";ctx.lineWidth=this.style.width;ctx.stroke();}else{if(!document.namespaces.vml){var stl=document.createStyleSheet();stl.addRule("vml\\:*","behavior: url(#default#VML);");document.namespaces.add("vml","urn:schemas-microsoft-com:vml");}var shapeEl=document.createElement("vml:shape");shapeEl.setAttribute("coordsize",parseInt(this.modelviewer.canvas.getStyle("width"))+", "+parseInt(this.modelviewer.canvas.getStyle("height")));MOVI.util.Overlay.superclass.constructor.call(this,shapeEl,{});var strokeEl=new YAHOO.util.Element(document.createElement("vml:stroke"));strokeEl.set("opacity",this.style.opacity);strokeEl.set("color",this.style.color);strokeEl.set("weight",this.style.width);strokeEl.set("joinstyle","round");strokeEl.set("endcap","round");var fillEl=new YAHOO.util.Element(document.createElement("vml:fill"));fillEl.set("opacity","0");var pathEl=new YAHOO.util.Element(document.createElement("vml:path"));var v="M "+Math.round(coords[0].x)+","+Math.round(coords[0].y)+" L";for(var i=1;i<coords.length;i++){v+=" "+Math.round(coords[i].x)+","+Math.round(coords[i].y);if(i!=coords.length-1){v+=",";}}pathEl.set("v",v);this.appendChild(strokeEl);this.appendChild(fillEl);this.appendChild(pathEl);}this.setStyle("position","absolute");this.setStyle("left","0px");this.setStyle("top","0px");this.modelviewer.canvas.appendChild(this);this.update();};MOVI.extend(MOVI.util.Overlay,YAHOO.util.Element,{update:function(){this.setStyle("width",Math.round(parseInt(this.modelviewer.canvas.getStyle("width"))*this.modelviewer.getZoomLevel()/100)+"px");this.setStyle("height",Math.round(parseInt(this.modelviewer.canvas.getStyle("height"))*this.modelviewer.getZoomLevel()/100)+"px");},remove:function(){this.modelviewer.canvas.removeChild(this);},show:function(){this.setStyle("display","block");},hide:function(){this.setStyle("display","none");}});MOVI.util.Marker=function(shapes,nodeStyle,edgeStyle){if(!shapes){shapes=[];}if(!YAHOO.lang.isArray(shapes)){shapes=[shapes];}this._icons={north:null,west:null,south:null,east:null,northwest:null,southwest:null,northeast:null,southeast:null};this._nodeStyle=nodeStyle||{};this._edgeStyle=edgeStyle||{};this.overlays={};this._shapes={};for(var i=0;i<shapes.length;i++){var s=shapes[i];this._shapes[s.resourceId]=s;if(s.isNode()){this.overlays[s.resourceId]=new YAHOO.util.Element(document.createElement("div"));this.overlays[s.resourceId].setStyle("position","absolute");s.appendChild(this.overlays[s.resourceId]);}else{this.overlays[s.resourceId]=new MOVI.util.Overlay(s.getCanvas().getModelViewer(),s.getCoordinates(),this._edgeStyle);}}this.markerRect=new YAHOO.util.Element(document.createElement("div"));this.markerRect.set("className",_MARKER_RECT_CLASS_NAME);this._update();};MOVI.util.Marker.PADDING=4;MOVI.util.Marker.prototype={_nodeStyle:null,_edgeStyle:null,_className:"",_shapes:null,_changedCallback:null,_canvasAvailableCallback:null,_icons:null,overlays:null,markerRect:null,canvas:null,_update:function(){var canvas=null;for(var i in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,i)){continue;}var shape=this._shapes[i];var overlay=this.overlays[i];if(canvas==null){canvas=shape.getCanvas();}var zoomFactor=canvas.getModelViewer().getZoomLevel()/100;if(shape.isEdge()){overlay.update();continue;}for(var prop in this._nodeStyle){if(!YAHOO.lang.hasOwnProperty(this._nodeStyle,prop)){continue;}overlay.setStyle(prop,this._nodeStyle[prop]);}var bTWidth=parseInt(overlay.getStyle("border-top-width")||0),bRWidth=parseInt(overlay.getStyle("border-right-width")||0),bBWidth=parseInt(overlay.getStyle("border-bottom-width")||0),bLWidth=parseInt(overlay.getStyle("border-left-width")||0);bTWidth=isNaN(bTWidth)?0:bTWidth;bRWidth=isNaN(bRWidth)?0:bRWidth;bBWidth=isNaN(bBWidth)?0:bBWidth;bLWidth=isNaN(bLWidth)?0:bLWidth;var left=-MOVI.util.Marker.PADDING;var top=-MOVI.util.Marker.PADDING;if(YAHOO.env.ua.ie){left=Math.round(left/2);top=Math.round(top/2);}var width=Math.round((shape.bounds.lowerRight.x-shape.bounds.upperLeft.x)*zoomFactor)+2*MOVI.util.Marker.PADDING-bLWidth-bRWidth;var height=Math.round((shape.bounds.lowerRight.y-shape.bounds.upperLeft.y)*zoomFactor)+2*MOVI.util.Marker.PADDING-bTWidth-bBWidth;overlay.setStyle("left",left+"px");overlay.setStyle("top",top+"px");overlay.setStyle("width",width+"px");overlay.setStyle("height",height+"px");overlay.set("className",this._className);}if(canvas!=null){if(this.canvas==null){this.canvas=canvas;this.canvas.appendChild(this.markerRect);for(var orientation in this._icons){if(!YAHOO.lang.hasOwnProperty(this._icons,orientation)){continue;}if(this._icons[orientation]){this.canvas.appendChild(this._icons[orientation]);}}this.canvas.getModelViewer().onZoomLevelChangeEnd.subscribe(function(){this._update();},this,true);this._onCanvasAvailable();}var bTWidth=parseInt(this.markerRect.getStyle("border-top-width")||0),bRWidth=parseInt(this.markerRect.getStyle("border-right-width")||0),bBWidth=parseInt(this.markerRect.getStyle("border-bottom-width")||0),bLWidth=parseInt(this.markerRect.getStyle("border-left-width")||0);bTWidth=isNaN(bTWidth)?0:bTWidth;bRWidth=isNaN(bRWidth)?0:bRWidth;bBWidth=isNaN(bBWidth)?0:bBWidth;bLWidth=isNaN(bLWidth)?0:bLWidth;var left=Math.round(this.getAbsBounds().upperLeft.x)*zoomFactor-MOVI.util.Marker.PADDING;var top=Math.round(this.getAbsBounds().upperLeft.y)*zoomFactor-MOVI.util.Marker.PADDING;var width=Math.round((this.getAbsBounds().lowerRight.x-this.getAbsBounds().upperLeft.x)*zoomFactor)+2*MOVI.util.Marker.PADDING-bLWidth-bRWidth;var height=Math.round((this.getAbsBounds().lowerRight.y-this.getAbsBounds().upperLeft.y)*zoomFactor)+2*MOVI.util.Marker.PADDING-bTWidth-bBWidth;this.markerRect.setStyle("left",left+"px");this.markerRect.setStyle("top",top+"px");this.markerRect.setStyle("width",width+"px");this.markerRect.setStyle("height",height+"px");}this._updateIcons();},_updateIcons:function(){if(this.canvas){var zoomFactor=this.canvas.getModelViewer().getZoomLevel()/100;}else{var zoomFactor=1;}var bounds=this.getAbsBounds();for(var orientation in this._icons){if(!YAHOO.lang.hasOwnProperty(this._icons,orientation)){continue;}var left,top,margin;var icon=this._icons[orientation];if(icon){var width=parseInt(icon.getStyle("width"),10);var height=parseInt(icon.getStyle("height"),10);if(orientation=="north"){left=Math.round(bounds.upperLeft.x*zoomFactor+((bounds.lowerRight.x-bounds.upperLeft.x)*zoomFactor-width)/2);top=Math.round(bounds.upperLeft.y*zoomFactor-height);margin=-_ICON_MARGIN+"px 0 0 0";}else{if(orientation=="east"){left=bounds.lowerRight.x*zoomFactor;top=Math.round(bounds.upperLeft.y*zoomFactor+((bounds.lowerRight.y-bounds.upperLeft.y)*zoomFactor-height)/2);margin="0 0 0 "+_ICON_MARGIN+"px";}else{if(orientation=="south"){left=Math.round(bounds.upperLeft.x*zoomFactor+((bounds.lowerRight.x-bounds.upperLeft.x)*zoomFactor-width)/2);top=bounds.lowerRight.y*zoomFactor;margin=_ICON_MARGIN+"px 0 0 0";}else{if(orientation=="west"){left=bounds.upperLeft.x*zoomFactor-width;top=Math.round(bounds.upperLeft.y*zoomFactor+((bounds.lowerRight.y-bounds.upperLeft.y)*zoomFactor-height)/2);margin="0 0 0 "+-_ICON_MARGIN+"px";}else{if(orientation=="northeast"){left=bounds.lowerRight.x*zoomFactor;top=bounds.upperLeft.y*zoomFactor-height;margin=-_ICON_MARGIN+"px 0 0 "+_ICON_MARGIN+"px";}else{if(orientation=="southeast"){left=bounds.lowerRight.x*zoomFactor;top=bounds.lowerRight.y*zoomFactor;margin=_ICON_MARGIN+"px 0 0 "+_ICON_MARGIN+"px";}else{if(orientation=="northwest"){left=bounds.upperLeft.x*zoomFactor-width;top=bounds.upperLeft.y*zoomFactor-height;margin=-_ICON_MARGIN+"px 0 0 "+-_ICON_MARGIN+"px";}else{if(orientation=="southwest"){left=bounds.upperLeft.x*zoomFactor-width;top=bounds.lowerRight.y*zoomFactor;margin=_ICON_MARGIN+"px 0 0 "+-_ICON_MARGIN+"px";}}}}}}}}icon.setStyle("left",left+"px");icon.setStyle("top",top+"px");icon.setStyle("margin",margin);}}},_onChanged:function(){if(!this._changedCallback){return;}this._changedCallback.callback.call(this._changedCallback.scope,this,this._changedCallback.data);},_onCanvasAvailable:function(){if(!this._canvasAvailableCallback){return;}this._canvasAvailableCallback.callback.call(this._canvasAvailableCallback.scope,this,this._canvasAvailableCallback.data);},setNodeStyle:function(property,value){this._nodeStyle[property]=value;this._update();},getNodeStyle:function(property){return this._nodeStyle[property];},setNodeClassName:function(className){this._className=className;this._update();},getNodeClassName:function(){return this._className;},setRectStyle:function(property,value){this.setNodeStyle(property,value);},getRectStyle:function(property){return this.getNodeStyle(property);},setRectClassName:function(className){this.setNodeClassName(className);},getRectClassName:function(){return this.getNodeClassName();},setEdgeStyle:function(property){this._edgeStyle[property]=value;for(var key in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,key)){continue;}this.overlays[key].remove();var coords=this.overlays[key].coords;var modelviewer=this.overlays[key].modelviewer;delete this.overlays[key];this.overlays[key]=new MOVI.util.Overlay(modelviewer,coords,this._edgeStyle);}},getEdgeStyle:function(property){return this._edgeStyle[property];},addShape:function(shape){if(this._shapes[shape.resourceId]){return;}this._shapes[shape.resourceId]=shape;if(shape.isNode()){var rect=new YAHOO.util.Element(document.createElement("div"));rect.set("className",this.getRectClassName());rect.setStyle("position","absolute");shape.appendChild(rect);this.overlays[shape.resourceId]=rect;}else{this.overlays[s.resourceId]=new MOVI.util.Overlay(shape.getCanvas().getModelViewer(),shape.getCoordinates());}this._update();this._onChanged();},removeShape:function(shape){if(shape.isNode()){shape.removeChild(this.overlays[shape.resourceId]);}else{this.overlays[shape.resourceId].remove();}delete this.overlays[shape.resourceId];delete this._shapes[shape.resourceId];this._update();this._onChanged();},removeAllShapes:function(){for(var key in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,key)){continue;}if(this._shapes[key].isNode()){this._shapes[key].removeChild(this.overlays[key]);}else{this.overlays[key].remove();}delete this.overlays[key];delete this._shapes[key];}this._update();this._onChanged();},getShapes:function(){var marked=new Array();for(var key in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,key)){continue;}marked.push(this._shapes[key]);}return marked;},show:function(){this.markerRect.setStyle("display","block");this.setRectStyle("display","block");for(var key in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,key)){continue;}if(this._shapes[key].isEdge()){this.overlays[key].show();}}for(var orientation in this._icons){if(!YAHOO.lang.hasOwnProperty(this._icons,orientation)){continue;}if(this._icons[orientation]){this._icons[orientation].setStyle("display","block");}}},hide:function(){this.markerRect.setStyle("display","none");this.setRectStyle("display","none");for(var key in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,key)){continue;}if(this._shapes[key].isEdge()){this.overlays[key].hide();}}for(var orientation in this._icons){if(!YAHOO.lang.hasOwnProperty(this._icons,orientation)){continue;}if(this._icons[orientation]){this._icons[orientation].setStyle("display","none");}}},fadeIn:function(){if(YAHOO.env.ua.ie){return;}for(var key in this.overlays){if(typeof key!="string"){return;}this.overlays[key].setStyle("opacity",0);var anim=new YAHOO.util.ColorAnim(this.overlays[key],{opacity:{to:1}},0.4,YAHOO.util.Easing.easeOut);anim.animate();}},fadeOut:function(fn){if(YAHOO.env.ua.ie){if(fn instanceof Function){fn();}return;}var anim;for(var key in this.overlays){if(typeof key!="string"){return;}anim=new YAHOO.util.ColorAnim(this.overlays[key],{opacity:{to:0}},0.4,YAHOO.util.Easing.easeOut);anim.animate();}if(anim&&fn instanceof Function){anim.onComplete.subscribe(fn);}},toggle:function(){if(this.markerRect.getStyle("display")=="none"){this.show();}else{this.hide();}},remove:function(){this.removeAllShapes();this.markerRect.get("element").parentNode.removeChild(this.markerRect.get("element"));delete this.markerRect;},getAbsBounds:function(){if(this._cachedAbsBounds){return this._cachedAbsBounds;}var upperLeft={x:undefined,y:undefined};lowerRight={x:undefined,y:undefined};for(var i in this._shapes){if(!YAHOO.lang.hasOwnProperty(this._shapes,i)){continue;}var bounds=this._shapes[i].getAbsBounds();if(upperLeft.x==undefined||bounds.upperLeft.x<upperLeft.x){upperLeft.x=bounds.upperLeft.x;}if(upperLeft.y==undefined||bounds.upperLeft.y<upperLeft.y){upperLeft.y=bounds.upperLeft.y;}if(lowerRight.x==undefined||bounds.lowerRight.x>lowerRight.x){lowerRight.x=bounds.lowerRight.x;}if(lowerRight.y==undefined||bounds.upperLeft.y>lowerRight.y){lowerRight.y=bounds.lowerRight.y;}}this._cachedAbsBounds={upperLeft:upperLeft,lowerRight:lowerRight};return this._cachedAbsBounds;},onChanged:function(callback,scope,data){if(!YAHOO.lang.isFunction(callback)){throw new TypeError("Specified callback is not a function.","error","marker.js");return;}if(!scope){scope=this;}this._changedCallback={callback:callback,scope:scope,data:data};},onCanvasAvailable:function(callback,scope,data){if(!YAHOO.lang.isFunction(callback)){throw new TypeError("Specified callback is not a function.","error","marker.js");return;}if(!scope){scope=this;}this._canvasAvailableCallback={callback:callback,scope:scope,data:data};},addIcon:function(orientation,icon){if(!YAHOO.lang.isString(orientation)){throw new TypeError("The orientation paramter is expected to be of type String","error","marker.js");return;}if(YAHOO.lang.isString(icon)){var img=new Image();var self=this;img.onload=function(){self._updateIcons.call(self);};img.src=icon;icon=new YAHOO.util.Element(img);}else{icon=new YAHOO.util.Element(icon);}icon.set("className",_ICON_CLASS_NAME);for(var key in this._icons){if(!YAHOO.lang.hasOwnProperty(this._icons,key)){continue;}if(key===orientation){if(this._icons[orientation]){this.removeIcon(orientation);}if(this.canvas){this.canvas.appendChild(icon);}this._icons[key]=icon;this._updateIcons();return icon;}}throw new Error("The specified orientation is not valid.","error","marker.js");},removeIcon:function(orientation){if(this._icons[orientation]&&this.canvas){this.canvas.removeChild(this._icons[orientation]);}this._icons[orientation]=null;},getIcon:function(orientation){return this._icons[orientation];}};})();MOVI.namespace("util");(function(){var _BUBBLE_VISIBLE_CLASS_NAME="movi-bubble-visible",_BUBBLE_HIDDEN_CLASS_NAME="movi-bubble-hidden",_BUBBLE_UL_CLASS_NAME="movi-bubble-ul",_BUBBLE_UR_CLASS_NAME="movi-bubble-ur",_BUBBLE_LL_CLASS_NAME="movi-bubble-ll",_BUBBLE_LR_CLASS_NAME="movi-bubble-lr",_BUBBLE_BORDERTOP_CLASS_NAME="movi-bubble-bt",_BUBBLE_BORDERBOTTOM_CLASS_NAME="movi-bubble-bb",_BUBBLE_BORDERLEFT_CLASS_NAME="movi-bubble-bl",_BUBBLE_BORDERRIGHT_CLASS_NAME="movi-bubble-br",_BUBBLE_ARROW_LEFT_CLASS_NAME="movi-bubble-al",_BUBBLE_ARROW_RIGHT_CLASS_NAME="movi-bubble-ar",_BUBBLE_ARROW_TOP_CLASS_NAME="movi-bubble-at",_BUBBLE_ARROW_BOTTOM_CLASS_NAME="movi-bubble-ab",_BUBBLE_CONTENT_CLASS_NAME="movi-bubble-bc",_BUBBLE_CLOSEBUTTON_CLASS_NAME="movi-bubble-closebutton";var Event=YAHOO.util.Event,Element=YAHOO.util.Element;MOVI.util.Annotation=function(marker,content){if(!marker){throw new Error("No marker specified for annotation.","annotation.js");return false;}if(!YAHOO.lang.isString(content)){throw new TypeError("A String is expected for the annotation's content.","annotation.js");}el=_createHostElement.call(this);MOVI.util.Annotation.superclass.constructor.call(this,el,{});_createBubble.call(this,content);this._content=new Element(this.getElementsByClassName(_BUBBLE_CONTENT_CLASS_NAME)[0]);this._marker=marker;this._marker.onChanged(this._update,this);(new Element(this.getElementsByClassName(_BUBBLE_CLOSEBUTTON_CLASS_NAME)[0])).addListener("click",this._close,this,this);this.addListener("mouseover",function(ev){Event.stopPropagation(ev);});this.addListener("mouseout",function(ev){Event.stopPropagation(ev);});this.addListener("click",function(ev){Event.stopPropagation(ev);});this.addListener("mousedown",function(ev){Event.stopPropagation(ev);});this.setStyle("-moz-user-select","text");this.setStyle("-webkit-user-select","text");this.setStyle("-khtml-user-select","text");if(YAHOO.env.ua.ie>0){this.set("unselectable","off");}this._update();};MOVI.extend(MOVI.util.Annotation,Element,{_contentElement:null,_marker:null,_canvas:null,_closeCallback:null,_close:function(){this.hide();if(this._closeCallback){this._closeCallback.callback.call(this._closeCallback.callback.scope,this,this._closeCallback.callback.data);}},_update:function(){var zoomFactor=1;if(!this._canvas){this._canvas=this._marker.canvas;if(this._canvas){this._canvas.appendChild(this);this._canvas.getModelViewer().onZoomLevelChangeEnd.subscribe(function(){this._update();},this,true);zoomFactor=this._canvas.getModelViewer().getZoomLevel()/100;}else{this._marker.onCanvasAvailable(this._update,this);}}else{zoomFactor=this._canvas.getModelViewer().getZoomLevel()/100;}var bounds=this._marker.getAbsBounds();var left=Math.round(bounds.upperLeft.x*zoomFactor);var right=Math.round(bounds.lowerRight.x*zoomFactor);var top=Math.round((bounds.upperLeft.y+(bounds.lowerRight.y-bounds.upperLeft.y)*0.7)*zoomFactor);var w=parseInt(this._canvas.getStyle("width"),10);if(left>(w/2)){this.setPosition(left,top);}else{this.setPosition(right,top);}},setPosition:function(x,y){var w=parseInt(this._canvas.getStyle("width"),10);if(w&&w>300&&(x>(w/2))){this.setStyle("right",(w-x)+"px");this.setStyle("left","");this.addClass("movi-bubble-right");}else{this.setStyle("left",x+"px");this.setStyle("right","");this.removeClass("movi-bubble-right");}this.setStyle("top",y+"px");},show:function(){this.replaceClass(_BUBBLE_HIDDEN_CLASS_NAME,_BUBBLE_VISIBLE_CLASS_NAME);this.bringToFront();this.visible=true;},hide:function(){this.replaceClass(_BUBBLE_VISIBLE_CLASS_NAME,_BUBBLE_HIDDEN_CLASS_NAME);this.visible=false;},toggle:function(){if(this.isVisible()){this.hide();}else{this.show();}},isVisible:function(){return"undefined"==typeof(this.visible)?this.hasClass(_BUBBLE_VISIBLE_CLASS_NAME):this.visible;},remove:function(){this.get("element").parentNode.removeChild(this.get("element"));},onClose:function(callback,scope,data){this._closeCallback={callback:callback,scope:scope,data:data};},bringToFront:function(){return;if(!this.get("element").parentNode){return;}MOVI.util.Annotation;var maxZIndex=0;var canvasEl=new Element(this.get("element").parentNode.parentNode);var elements=canvasEl.getElementsByClassName(_BUBBLE_VISIBLE_CLASS_NAME);for(var key in elements){if(!YAHOO.lang.hasOwnProperty(elements,key)){continue;}var zIndex=parseInt((new Element(elements[key].parentNode)).getStyle("z-index"),10);if(zIndex>maxZIndex){maxZIndex=zIndex;}}this._marker.markerRect.setStyle("z-index",maxZIndex+1);},setMarker:function(marker){this._canvas=undefined;this._marker=marker;this._marker.onChanged(this._update,this);this._update();},getMarker:function(marker){return this._marker;}});var _createHostElement=function(){var el=document.createElement("div");return el;};var _createBubble=function(content){var isIE6=YAHOO.env.ua.ie===6;this.set("className",_BUBBLE_HIDDEN_CLASS_NAME);this.set("innerHTML",['<div class="'+_BUBBLE_UL_CLASS_NAME+'">',(isIE6?'<img class="'+_BUBBLE_UL_CLASS_NAME+'">':""),'<div class="'+_BUBBLE_UR_CLASS_NAME+'">',(isIE6?'<img class="'+_BUBBLE_UR_CLASS_NAME+'">':""),'<div class="'+_BUBBLE_LL_CLASS_NAME+'">',(isIE6?'<img class="'+_BUBBLE_LL_CLASS_NAME+'">':""),'<div class="'+_BUBBLE_LR_CLASS_NAME+'">',(isIE6?'<img class="'+_BUBBLE_LR_CLASS_NAME+'">':""),'<div class="'+_BUBBLE_BORDERTOP_CLASS_NAME+'"></div>','<div class="'+_BUBBLE_BORDERLEFT_CLASS_NAME+'">',(isIE6?'<img class="'+_BUBBLE_BORDERLEFT_CLASS_NAME+'">':""),'<div class="'+_BUBBLE_BORDERRIGHT_CLASS_NAME+'">',(isIE6?'<img class="'+_BUBBLE_BORDERRIGHT_CLASS_NAME+'">':""),'<div class="'+_BUBBLE_CONTENT_CLASS_NAME+'">','<div class="'+_BUBBLE_CLOSEBUTTON_CLASS_NAME+'"></div>',content,"</div>","</div>","</div>",'<div class="'+_BUBBLE_BORDERBOTTOM_CLASS_NAME+'"></div>',"</div>","</div>","</div>","</div>",'<div class="'+_BUBBLE_ARROW_LEFT_CLASS_NAME+'"/>'].join(""));};})();MOVI.namespace("widget");(function(){var _NAVIGATOR_CLASS_NAME="movi-navigator",_CLIPPING_RECT_CLASS_NAME="movi-navigator-clippingrect",_NAVIGATOR_IMG_CLASS_NAME="movi-navigator-img";var _setUpHostElement=function(){if(this.getStyle("position")=="static"){this.setStyle("position","relative");}this.set("innerHTML",'<img class="'+_NAVIGATOR_IMG_CLASS_NAME+'" /><div class="'+_CLIPPING_RECT_CLASS_NAME+'" />');};MOVI.widget.ModelNavigator=function(el,modelviewer){if(!modelviewer){throw new Error("No model viewer specified for model navigator","modelnavigator.js");return false;}this.modelviewer=modelviewer;MOVI.widget.ModelNavigator.superclass.constructor.call(this,el);_setUpHostElement.call(this);this._clippingRect=new YAHOO.util.Element(this.getElementsByClassName(_CLIPPING_RECT_CLASS_NAME)[0]);this._image=new YAHOO.util.Element(this.getElementsByTagName("img")[0]);this.addClass(_NAVIGATOR_CLASS_NAME);var scrollboxId=this.modelviewer.getScrollboxEl().get("id");if(!scrollboxId||!YAHOO.util.Event.addListener(scrollboxId,"scroll",this.update,this,true)){throw new Error("Could not add event listener to scrollbox","modelnavigator.js");}this.modelviewer.onZoomLevelChange.subscribe(this.update,this,true);this._clippingRect.addListener("mousedown",this._onClippingRectDrag,this,this,true);this._clippingRect.addListener("click",function(ev){YAHOO.util.Event.stopEvent(ev);},this,this,true);this.addListener("click",this._onClick,this,this,true);YAHOO.util.Event.addListener(document,"mouseup",this._onMouseUp,this,this,true);this._absXY=[];this._mouseOffset={x:0,y:0};this.update();};MOVI.extend(MOVI.widget.ModelNavigator,YAHOO.util.Element,{_clippingRect:null,_image:null,_absXY:null,_mouseOffset:null,modelviewer:null,_onClippingRectDrag:function(ev){YAHOO.util.Event.preventDefault(ev);this._absXY=YAHOO.util.Dom.getXY(this);var mouseAbsXY=YAHOO.util.Event.getXY(ev);var clippingRectAbsXY=YAHOO.util.Dom.getXY(this._clippingRect);this._mouseOffset.x=mouseAbsXY[0]-clippingRectAbsXY[0];this._mouseOffset.y=mouseAbsXY[1]-clippingRectAbsXY[1];this.addListener("mousemove",this._onClippingRectMove,this,this,true);},_onMouseUp:function(ev){YAHOO.util.Event.preventDefault(ev);this.removeListener("mousemove",this._onClippingRectMove);},_onClick:function(ev){YAHOO.util.Event.preventDefault(ev);this._absXY=YAHOO.util.Dom.getXY(this);var mouseAbsXY=YAHOO.util.Event.getXY(ev);var navigatorWidth=parseInt(this.getStyle("width"),10);var scale=this.modelviewer.getImgWidth()/navigatorWidth;var zoomFactor=this.modelviewer.getZoomLevel()/100;var centerX=Math.round(scale*(mouseAbsXY[0]-this._absXY[0])*zoomFactor);var centerY=Math.round(scale*(mouseAbsXY[1]-this._absXY[1])*zoomFactor);this.modelviewer.centerScrollTo(centerX,centerY);},_onClippingRectMove:function(ev){YAHOO.util.Event.preventDefault(ev);var mouseAbsXY=YAHOO.util.Event.getXY(ev);var x=mouseAbsXY[0]-this._absXY[0]-this._mouseOffset.x,y=mouseAbsXY[1]-this._absXY[1]-this._mouseOffset.y;var navigatorWidth=parseInt(this.getStyle("width"),10);var scale=this.modelviewer.getImgWidth()/navigatorWidth;var zoomFactor=this.modelviewer.getZoomLevel()/100;var scrollboxEl=this.modelviewer.getScrollboxEl();scrollboxEl.set("scrollLeft",Math.round(scale*x*zoomFactor));scrollboxEl.set("scrollTop",Math.round(scale*y*zoomFactor));},update:function(){var zoomFactor=this.modelviewer.getZoomLevel()/100;var pngUrl=this.modelviewer.getModelUri()+"/png";var scrollboxEl=this.modelviewer.getScrollboxEl();if(this._image.get("src")!=pngUrl){this._image.set("src",pngUrl);}var navigatorWidth=parseInt(this.getStyle("width"),10);var scale=navigatorWidth/this.modelviewer.getImgWidth();if(scale>1){navigatorWidth=this.modelviewer.getImgWidth();this.setStyle("width",navigatorWidth+"px");scale=1;}var navigatorHeight=Math.round(scale*this.modelviewer.getImgHeight());this.setStyle("height",navigatorHeight+"px");var left=Math.round(scale*scrollboxEl.get("scrollLeft")/zoomFactor);var top=Math.round(scale*scrollboxEl.get("scrollTop")/zoomFactor);var scrollboxWidth=parseInt(scrollboxEl.getStyle("width"),10);var scrollboxHeight=parseInt(scrollboxEl.getStyle("height"),10);var clippingRectWidth=Math.round(scale*scrollboxWidth/zoomFactor);var clippingRectHeight=Math.round(scale*scrollboxHeight/zoomFactor);if(left+clippingRectWidth>navigatorWidth){clippingRectWidth=navigatorWidth-left;}if(top+clippingRectHeight>navigatorHeight){clippingRectHeight=navigatorHeight-top;}this._clippingRect.setStyle("width",clippingRectWidth+"px");this._clippingRect.setStyle("height",clippingRectHeight+"px");this._clippingRect.setStyle("left",left+"px");this._clippingRect.setStyle("top",top+"px");}});})();MOVI.namespace("util");(function(){var _SELECT_RECT_CLASS_NAME="movi-select-rect",_HIGHLIGHT_RECT_CLASS_NAME="movi-highlight-rect";var Marker=MOVI.util.Marker,Event=YAHOO.util.Event;MOVI.util.ShapeSelect=function(modelviewer,shapes,multiselect){if(!modelviewer){throw new Error("No model viewer specified for shape select.","error","shapeselect.js");return false;}if(!YAHOO.lang.isArray(shapes)){if(shapes==true){multiselect=true;}shapes=modelviewer.canvas.getNodes();}this._allowMultiselect=multiselect;this._selectableShapes={};this._selectedShapes={};this._highlightMarkers={};for(var key in shapes){if(!YAHOO.lang.hasOwnProperty(shapes,key)){continue;}var shape=modelviewer.canvas.shapes[key];if(shape.parentShape!=null){shape.addListener("mouseover",this._onMouseOver,shape,this);shape.addListener("mouseout",this._onMouseOut,shape,this);shape.addListener("click",this._onClick,shape,this);this._selectableShapes[shape.resourceId]=shape;}}modelviewer.canvas.addListener("click",this.reset,null,this);this._selectionMarker=new Marker();this._selectionMarker.setRectClassName(_SELECT_RECT_CLASS_NAME);this._selectionMarker.show();this._init();};MOVI.util.ShapeSelect.prototype={_selectableShapes:null,_selectedShapes:null,_highlightMarkers:null,_selectionMarker:null,_selectionChangedCallback:null,_allowMultiselect:false,_init:function(){for(var key in this._selectableShapes){if(!YAHOO.lang.hasOwnProperty(this._selectableShapes,key)){continue;}var s=this._selectableShapes[key];var marker=new Marker(s);marker.setRectClassName(_HIGHLIGHT_RECT_CLASS_NAME);marker.hide();this._highlightMarkers[s.resourceId]=marker;}},_onMouseOver:function(ev,shape){Event.stopPropagation(ev);if(!this._selectedShapes[shape.resourceId]){this.highlight(shape);}},_onMouseOut:function(ev,shape){Event.stopPropagation(ev);if(!this._selectedShapes[shape.resourceId]){this.unhighlight(shape);}},_onClick:function(ev,shape){Event.stopPropagation(ev);if(this._selectedShapes[shape.resourceId]){this.deselect(shape);}else{if(!this._allowMultiselect){this._reset();}this.select(shape);}},_onSelectionChanged:function(){if(!this._selectionChangedCallback){return;}this._selectionChangedCallback.callback.call(this._selectionChangedCallback.scope,this,this._selectionChangedCallback.data);},_reset:function(){for(var key in this._selectedShapes){if(!YAHOO.lang.hasOwnProperty(this._selectableShapes,key)){continue;}var s=this._selectedShapes[key];this._selectionMarker.removeShape(s);delete this._selectedShapes[key];}},select:function(shapes){if(!YAHOO.lang.isArray(shapes)){shapes=[shapes];}for(var key in shapes){if(!YAHOO.lang.hasOwnProperty(shapes,key)){continue;}var s=shapes[key];this.unhighlight(s);if(!this._selectableShapes[s.resourceId]){MOVI.log("Specified shape with resource id "+s.resourceId+" is not selectable.","warn","shapeselect.js");continue;}this._selectedShapes[s.resourceId]=s;this._selectionMarker.addShape(s);}this._onSelectionChanged();},deselect:function(shapes){if(!YAHOO.lang.isArray(shapes)){shapes=[shapes];}for(var key in shapes){if(!YAHOO.lang.hasOwnProperty(shapes,key)){continue;}var s=shapes[key];delete this._selectedShapes[s.resourceId];this._selectionMarker.removeShape(s);}this._onSelectionChanged();},highlight:function(shape){this._highlightMarkers[shape.resourceId].show();},unhighlight:function(shape){this._highlightMarkers[shape.resourceId].hide();},reset:function(){if(this.getSelectedShapes().length==0){return;}this._reset();this._onSelectionChanged();},getSelectedShapes:function(){var selected=new Array();for(var key in this._selectedShapes){if(!YAHOO.lang.hasOwnProperty(this._selectedShapes,key)){continue;}selected.push(this._selectedShapes[key]);}return selected;},getSelectionMarker:function(){return this._selectionMarker;},onSelectionChanged:function(callback,scope,data){if(!YAHOO.lang.isFunction(callback)){throw new TypeError("Specified callback is not a function.","shapeselect.js");return;}if(!scope){scope=this;}this._selectionChangedCallback={callback:callback,scope:scope,data:data};}};})();MOVI.namespace("widget");(function(){var _TOOLBAR_CLASS_NAME="movi-toolbar",_TOOLBAR_BUTTON_CLASS_NAME="movi-toolbar-button",_TOOLBAR_GROUP_CLASS_NAME="movi-toolbar-group";_TOOLBAR_GROUP_LABEL_CLASS_NAME="movi-toolbar-group-label";var _DEFAULT_GROUP_NAME="movi-toolbar-default-group";MOVI.widget.Toolbar=function(el,modelviewer){this.modelviewer=modelviewer;this._groups={};MOVI.widget.Toolbar.superclass.constructor.call(this,el);this.addClass(_TOOLBAR_CLASS_NAME);};MOVI.extend(MOVI.widget.Toolbar,YAHOO.util.Element,{_groups:null,modelviewer:null,_update:function(){this.set("innerHTML","");for(var key in this._groups){if(!YAHOO.lang.hasOwnProperty(this._groups,key)){continue;}var group=this._groups[key];var groupEl=new YAHOO.util.Element(document.createElement("div"));groupEl.set("className",_TOOLBAR_GROUP_CLASS_NAME);this.appendChild(groupEl);if(this._showGroupCaptions){var groupLabelEl=new YAHOO.util.Element(document.createElement("div"));groupLabelEl.set("className",_TOOLBAR_GROUP_LABEL_CLASS_NAME);groupEl.appendChild(groupLabelEl);if(key!=_DEFAULT_GROUP_NAME){groupLabelEl.set("innerHTML",key);}}for(var i=0;i<group.length;i++){if(group[i]){groupEl.appendChild(group[i]);}}}var clearDiv=new YAHOO.util.Element(document.createElement("div"));clearDiv.setStyle("clear","left");this.appendChild(clearDiv);},addButton:function(config){if(!YAHOO.lang.isFunction(config.callback)){throw new Error("No valid callback method specified","toolbar.js");return null;}var button=new YAHOO.util.Element(document.createElement("div"));button.set("className",_TOOLBAR_BUTTON_CLASS_NAME);var scope=config.scope?config.scope:this;button.on("click",config.callback,config.data,scope);if(config.icon){if(!YAHOO.lang.isString(config.icon)){throw new TypeError("The icon has to be a String value","toolbar.js");return null;}var iconEl=new YAHOO.util.Element(document.createElement("img"));iconEl.set("src",config.icon);button.appendChild(iconEl);}if(config.caption){if(!YAHOO.lang.isString(config.caption)){throw new TypeError("The caption has to be a String value","toolbar.js");return null;}var captionEl=new YAHOO.util.Element(document.createElement("span"));captionEl.set("html",config.caption);}if(!config.icon&&!config.caption){throw new Error("At least one - icon or caption - must be specified","toolbar.js");return false;}if(config.tooltip){if(!YAHOO.lang.isString(config.tooltip)){throw new TypeError("The tooltip has to be a String value","toolbar.js");return null;}button.set("title",config.tooltip);if(iconEl){iconEl.set("alt",config.tooltip);}}if(config.group){if(!YAHOO.lang.isString(config.group)){throw new TypeError("The group has to be a String value","toolbar.js");return null;}var groupName=config.group;var buttonId=groupName;}else{var groupName=_DEFAULT_GROUP_NAME;var buttonId="";}if(!this._groups[groupName]){this._groups[groupName]=new Array();}this._groups[groupName].push(button);buttonId+="_"+this._groups[groupName].length-1;this._update();return buttonId;},removeButton:function(id){var i=id.lastIndexOf("_");var groupName=id.substring(0,i-1);var index=id.substring(i+1);this._groups[groupName][index]=undefined;this._update();},showGroupCaptions:function(){this._showGroupCaptions=true;this._update();},hideGroupCaptions:function(){this._showGroupCaptions=false;this._update();}});})();MOVI.namespace("widget");(function(){var _SLIDER_CLASS_NAME_PREFIX="movi-zoomslider",_SLIDER_THUMB_CLASS_NAME="movi-zoomslider-thumb",_SLIDER_DEFAULT_LENGTH=100,_SLIDER_DEFAULT_STEP=1,_FULLSCREEN_LIGHTBOX_CLASS_NAME="movi-fullscreen-lightbox",_FULLSCREEN_CONTAINER_CLASS_NAME="movi-fullscreen-modelcontainer";var _setUpHostElementZoomSlider=function(){var div1=new YAHOO.util.Element(document.createElement("div"));div1.set("id",_SLIDER_CLASS_NAME_PREFIX+this.modelviewer.getIndex());div1.addClass(_SLIDER_CLASS_NAME_PREFIX+"-"+this.orientation);div1.set("title","Zoom Slider");var div2=new YAHOO.util.Element(document.createElement("div"));div2.set("id",_SLIDER_THUMB_CLASS_NAME+this.modelviewer.getIndex());div2.addClass(_SLIDER_THUMB_CLASS_NAME);div1.appendChild(div2);this.appendChild(div1);};var _getMinZoomLevel=function(modelviewer){var scaleHorizontal=(modelviewer.getScrollboxEl().get("offsetWidth")-5)/modelviewer.getImgWidth();var scaleVertical=(modelviewer.getScrollboxEl().get("offsetHeight")-5)/modelviewer.getImgHeight();var scale=(scaleHorizontal<scaleVertical)?scaleHorizontal:scaleVertical;if(scale>1){scale=1;}return scale*100;};MOVI.widget.ZoomSlider=function(el,modelviewer,opt){if(!modelviewer){throw new Error("No model viewer specified for zoom slider","zoom.js");return false;}this.modelviewer=modelviewer;MOVI.widget.ZoomSlider.superclass.constructor.call(this,el);if(!opt){opt={};}this.orientation=opt.orientation||"horizontal";this.trackLength=opt.trackLength||_SLIDER_DEFAULT_LENGTH;this.step=opt.step||_SLIDER_DEFAULT_STEP;this.reverse=opt.reverse||false;_setUpHostElementZoomSlider.call(this);if(this.orientation=="vertical"){this.slider=YAHOO.widget.Slider.getVertSlider(_SLIDER_CLASS_NAME_PREFIX+this.modelviewer.getIndex(),_SLIDER_THUMB_CLASS_NAME+this.modelviewer.getIndex(),0,this.trackLength,this.step);}else{this.slider=YAHOO.widget.Slider.getHorizSlider(_SLIDER_CLASS_NAME_PREFIX+this.modelviewer.getIndex(),_SLIDER_THUMB_CLASS_NAME+this.modelviewer.getIndex(),0,this.trackLength,this.step);}this.update();this.slider.subscribe("change",this.onChange,this,true);this.slider.subscribe("slideStart",this._onSlideStart,this,true);this.slider.subscribe("slideEnd",this._onSlideEnd,this,true);this.modelviewer.onModelLoadEnd.subscribe(this.update,this,true);};MOVI.extend(MOVI.widget.ZoomSlider,YAHOO.util.Element,{slider:null,_onSlideStart:function(){this.modelviewer.onZoomLevelChangeStart.fire(this.modelviewer.getZoomLevel());},_onSlideEnd:function(){this.modelviewer.onZoomLevelChangeEnd.fire(this.modelviewer.getZoomLevel());},onChange:function(){var minZoomLevel=_getMinZoomLevel(this.modelviewer);var maxZoomLevel=100;var zoomStep=(maxZoomLevel-minZoomLevel)/this.trackLength;if(this.reverse){this.modelviewer.setZoomLevel(minZoomLevel+(this.trackLength-this.slider.getValue())*zoomStep,false);}else{this.modelviewer.setZoomLevel(minZoomLevel+this.slider.getValue()*zoomStep,false);}},update:function(){var minZoomLevel=_getMinZoomLevel(this.modelviewer);var maxZoomLevel=100;var zoomStep=(maxZoomLevel-minZoomLevel)/this.trackLength;if(this.reverse){this.slider.setValue(this.trackLength-(this.modelviewer.getZoomLevel()-minZoomLevel)/zoomStep,false,true,true);}else{this.slider.setValue((this.modelviewer.getZoomLevel()-minZoomLevel)/zoomStep,false,true,true);}}});var _swapNode=function(n1,n2){if(n1.swapNode){n1.swapNode(n2);}else{var p=n2.parentNode;var s=n2.nextSibling;if(s==n1){p.insertBefore(n1,n2);}else{if(n2==n1.nextSibling){p.insertBefore(n2,n1);}else{n1.parentNode.replaceChild(n2,n1);p.insertBefore(n1,s);}}}};var _setUpHostElementFullscreenViewer=function(){var el=new YAHOO.util.Element(document.createElement("div"));el.set("innerHTML",'<div class="hd"></div><div class="bd"><div class="'+_FULLSCREEN_CONTAINER_CLASS_NAME+'"></div></div><div class="ft"></div>');(new YAHOO.util.Element(document.body)).appendChild(el);return el;};MOVI.widget.FullscreenViewer=function(modelviewer){this.modelviewer=modelviewer;var el=_setUpHostElementFullscreenViewer();el.addClass(_FULLSCREEN_LIGHTBOX_CLASS_NAME);var elId=_FULLSCREEN_LIGHTBOX_CLASS_NAME+this.modelviewer.getIndex();el.set("id",elId);MOVI.widget.FullscreenViewer.superclass.constructor.call(this,el);this.dialog=new YAHOO.widget.Dialog(elId,{fixedcenter:true,visible:false,draggable:true,modal:true,close:true,constraintoviewport:true});this.dialog.render();YAHOO.util.Event.on(YAHOO.util.Dom.getElementsByClassName("container-close","a",elId),"click",this.close,this,true);this._fullscreenContainer=new YAHOO.util.Element(el.getElementsByClassName(_FULLSCREEN_CONTAINER_CLASS_NAME)[0]);this._modelViewerPlaceholder=new YAHOO.util.Element(document.createElement("div"));this._fullscreenContainer.appendChild(this._modelViewerPlaceholder);};MOVI.extend(MOVI.widget.FullscreenViewer,YAHOO.util.Element,{_fullscreenContainer:null,_modelViewerPlaceholder:null,dialog:null,open:function(){this.dialog.cfg.setProperty("width",(YAHOO.util.Dom.getViewportWidth()-20)+"px");this.dialog.cfg.setProperty("height",(YAHOO.util.Dom.getViewportHeight()-20)+"px");_swapNode(this.modelviewer.getScrollboxEl().get("element"),this._modelViewerPlaceholder.get("element"));var minZoomLevel=_getMinZoomLevel(this.modelviewer);this._originalZoomLevel=this.modelviewer.getZoomLevel();this.modelviewer.setZoomLevel(minZoomLevel);this.dialog.show();},close:function(){_swapNode(this.modelviewer.getScrollboxEl().get("element"),this._modelViewerPlaceholder.get("element"));this.modelviewer.setZoomLevel(this._originalZoomLevel);this.dialog.hide();}});})();